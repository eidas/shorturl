# 短縮URLサービス設計書

## 1. システムアーキテクチャ概要

### 1.1 アーキテクチャ図（テキスト表現）
```
[開発環境]
    ↓
[ビルドスクリプト] ← [設定ファイル(urls.json)]
    ↓
[静的ファイル生成]
    ↓
[GitHub Repository]
    ↓
[GitHub Actions (CI/CD)]
    ↓
[GitHub Pages (ホスティング)]
    ↓
[エンドユーザー]
```

### 1.2 システム構成要素
- **設定管理層**: URLマッピング設定の管理
- **ビルド層**: 静的ファイルの自動生成
- **デプロイ層**: GitHub Actionsによる自動デプロイ
- **ホスティング層**: GitHub Pagesによる配信
- **フロントエンド層**: リダイレクト処理とUI表示

## 2. モジュール構造

### 2.1 全体ディレクトリ構成
```
shorturl/
├── .github/
│   └── workflows/
│       └── deploy.yml          # GitHub Actions ワークフロー定義
├── src/
│   ├── templates/              # HTMLテンプレート
│   │   ├── redirect.html       # リダイレクトページテンプレート
│   │   ├── index.html          # トップページテンプレート
│   │   └── 404.html            # エラーページテンプレート
│   ├── styles/                 # CSSファイル
│   │   ├── main.css            # メインスタイルシート
│   │   └── redirect.css        # リダイレクトページ用スタイル
│   └── scripts/                # JavaScriptファイル
│       ├── redirect.js         # リダイレクト処理スクリプト
│       └── analytics.js        # アナリティクス統合スクリプト
├── config/
│   ├── urls.json               # URLマッピング設定ファイル
│   └── site.json               # サイト全体設定ファイル
├── build/
│   ├── generator.js            # ビルドスクリプト（Node.js版）
│   ├── generator.py            # ビルドスクリプト（Python版）
│   └── validator.js            # 設定バリデーションスクリプト
├── docs/                       # ビルド出力先（GitHub Pagesのソース）
│   ├── index.html
│   ├── 404.html
│   ├── assets/
│   │   ├── css/
│   │   └── js/
│   └── [短縮キー]/
│       └── index.html
├── tests/
│   ├── validator.test.js       # バリデーションテスト
│   └── generator.test.js       # ジェネレーターテスト
├── package.json                # Node.js依存関係定義
├── requirements.txt            # Python依存関係定義（Python版使用時）
├── README.md                   # プロジェクト説明書
└── .gitignore                  # Git除外設定
```

## 3. モジュール詳細設計

### 3.1 設定管理モジュール

#### 3.1.1 urls.json（URLマッピング設定）
**目的**: 短縮URLと完全URLのマッピングを定義

**データスキーマ**:
```json
{
  "urls": {
    "短縮キー": {
      "url": "string (必須) - リダイレクト先URL",
      "description": "string (任意) - URLの説明",
      "created": "string (任意) - 作成日時 (ISO 8601形式)",
      "tags": "array (任意) - タグリスト",
      "enabled": "boolean (任意, デフォルト: true) - 有効/無効フラグ",
      "metadata": {
        "title": "string (任意) - OGPタイトル",
        "image": "string (任意) - OGP画像URL",
        "customRedirectDelay": "number (任意) - カスタムリダイレクト遅延(秒)"
      }
    }
  }
}
```

**バリデーションルール**:
- 短縮キーは英数字とハイフン、アンダースコアのみ許可
- 短縮キーの長さ: 1-50文字
- URLは有効なHTTP/HTTPSスキームを持つこと
- 短縮キーの重複チェック
- 予約キー（index, assets, config等）の使用禁止

#### 3.1.2 site.json（サイト設定）
**目的**: サイト全体の設定を管理

**データスキーマ**:
```json
{
  "site": {
    "title": "string - サイトタイトル",
    "description": "string - サイト説明",
    "baseUrl": "string - ベースURL",
    "author": "string - 作成者名",
    "analytics": {
      "googleAnalyticsId": "string (任意) - Google Analytics ID",
      "enabled": "boolean - アナリティクス有効化フラグ"
    },
    "theme": {
      "primaryColor": "string - プライマリカラー",
      "backgroundColor": "string - 背景色"
    },
    "features": {
      "showUrlList": "boolean - URL一覧表示の有効化",
      "enableQrCode": "boolean - QRコード生成の有効化"
    }
  }
}
```

### 3.2 ビルド・生成モジュール

#### 3.2.1 generator.js / generator.py（ビルドジェネレーター）
**目的**: 設定ファイルから静的HTMLファイルを自動生成

**主要機能**:
1. **設定ファイル読み込み**
   - urls.jsonとsite.jsonをパース
   - JSONスキーマバリデーション実行

2. **テンプレート処理**
   - HTMLテンプレートの読み込み
   - プレースホルダーの置換処理
   - 動的コンテンツの埋め込み

3. **リダイレクトページ生成**
   - 各短縮キーごとにディレクトリを作成
   - リダイレクト用index.htmlを生成
   - メタタグ（OGP、meta refresh等）の埋め込み

4. **インデックスページ生成**
   - 全短縮URLのリスト表示ページ作成
   - フィルタリング・検索機能のHTMLを生成
   - 統計情報の表示（URL数等）

5. **404ページ生成**
   - カスタムエラーページの作成
   - 利用可能なURL一覧へのリンク

6. **アセットコピー**
   - CSS/JSファイルのコピーまたは最適化
   - 画像ファイルの処理

**処理フロー**:
```
1. 設定ファイル読み込み
2. バリデーション実行
3. 出力ディレクトリのクリーンアップ
4. テンプレート読み込み
5. For each URL in urls.json:
   a. ディレクトリ作成
   b. リダイレクトHTML生成
6. インデックスページ生成
7. 404ページ生成
8. アセットファイルコピー
9. ビルドレポート出力
```

**入力**:
- config/urls.json
- config/site.json
- src/templates/*.html
- src/styles/*.css
- src/scripts/*.js

**出力**:
- docs/ 配下の全静的ファイル

#### 3.2.2 validator.js（バリデーター）
**目的**: 設定ファイルの整合性チェック

**検証項目**:
1. **JSONフォーマット検証**
   - JSONパース可能性
   - スキーマ準拠性

2. **URL検証**
   - URL形式の正当性
   - HTTPSスキームの推奨チェック
   - 到達可能性チェック（オプション）

3. **短縮キー検証**
   - 文字種制限チェック
   - 長さ制限チェック
   - 重複チェック
   - 予約語チェック

4. **セキュリティ検証**
   - リダイレクト先のホワイトリストチェック（オプション）
   - 悪意のあるURLパターン検出

**出力**:
- 検証成功/失敗のステータス
- エラー・警告メッセージリスト
- 検証レポート（JSON形式）

### 3.3 フロントエンドモジュール

#### 3.3.1 redirect.html（リダイレクトページテンプレート）
**目的**: 個別短縮URLのリダイレクトページ

**含まれる要素**:
- DOCTYPE宣言とHTML構造
- meta refreshタグ（フォールバック用）
- OGPメタタグ（SNSシェア対応）
- canonical URLタグ
- リダイレクト先情報の表示UI
- JavaScriptリダイレクトコード埋め込みエリア
- アナリティクストラッキングコード

**プレースホルダー**:
- `{{TARGET_URL}}`: リダイレクト先URL
- `{{SHORT_KEY}}`: 短縮キー
- `{{DESCRIPTION}}`: URL説明
- `{{TITLE}}`: ページタイトル
- `{{OGP_IMAGE}}`: OGP画像URL
- `{{REDIRECT_DELAY}}`: リダイレクト遅延時間

#### 3.3.2 index.html（トップページテンプレート）
**目的**: サイトのトップページ、URL一覧表示

**含まれる要素**:
- サイトヘッダー・ナビゲーション
- サービス説明セクション
- 短縮URL一覧テーブル/カード表示
- 検索・フィルタリング機能UI
- 統計情報表示（総URL数等）
- フッター（著作権表示、リンク等）

**動的機能**:
- クライアントサイド検索
- タグフィルタリング
- ソート機能
- QRコード表示モーダル（オプション）

**データソース**:
- ビルド時に埋め込まれたJSON配列
- または別途生成されるurls-list.json

#### 3.3.3 404.html（エラーページテンプレート）
**目的**: 存在しない短縮URLアクセス時の表示

**含まれる要素**:
- エラーメッセージ
- トップページへのリンク
- URL一覧へのリンク
- 検索機能（既存URLから候補を提示）
- サイトマップ的なナビゲーション

### 3.4 スクリプトモジュール

#### 3.4.1 redirect.js（リダイレクト処理）
**目的**: クライアントサイドリダイレクトの実行

**主要機能**:
1. **即座のリダイレクト実行**
   - window.location.hrefによるリダイレクト
   - meta refreshのフォールバック

2. **リダイレクト前の処理**
   - アナリティクスイベント送信
   - カスタム遅延処理
   - ユーザーへの通知表示

3. **エラーハンドリング**
   - リダイレクト失敗時の処理
   - タイムアウト処理

**パラメータ**:
- targetUrl: リダイレクト先URL
- delay: 遅延時間（ミリ秒）
- analyticsEnabled: アナリティクス有効化フラグ

#### 3.4.2 analytics.js（アナリティクス統合）
**目的**: アクセス解析の統合

**主要機能**:
1. **Google Analytics統合**
   - GAスクリプトのロード
   - ページビュートラッキング
   - カスタムイベント送信

2. **イベントトラッキング**
   - リダイレクトイベント
   - 短縮キークリックイベント
   - エラーページアクセスイベント

3. **プライバシー考慮**
   - Cookie同意管理（オプション）
   - IP匿名化設定

### 3.5 CI/CDモジュール

#### 3.5.1 deploy.yml（GitHub Actionsワークフロー）
**目的**: プッシュ時の自動ビルド・デプロイ

**トリガー**:
- mainブランチへのプッシュ
- config/urls.jsonの変更時
- 手動トリガー（workflow_dispatch）

**ジョブフロー**:
```
1. チェックアウト
   - リポジトリのクローン

2. 環境セットアップ
   - Node.jsまたはPythonのセットアップ
   - 依存関係のインストール

3. バリデーション
   - validator.jsの実行
   - 設定ファイルの検証

4. ビルド
   - generator.jsの実行
   - 静的ファイル生成

5. テスト
   - リンク切れチェック
   - HTMLバリデーション

6. デプロイ
   - GitHub Pagesへのデプロイ
   - CNAME設定（カスタムドメイン使用時）

7. 通知
   - ビルド成功/失敗の通知
   - Slack/Discord連携（オプション）
```

**環境変数**:
- GITHUB_TOKEN: GitHub認証トークン
- GA_ID: Google Analytics ID（オプション）
- DEPLOY_BRANCH: デプロイブランチ（通常はgh-pages）

**成果物**:
- ビルドログ
- デプロイされた静的サイト
- ビルドレポート

## 4. データフロー

### 4.1 URL追加フロー
```
1. 開発者がurls.jsonを編集
2. Git commit & push
3. GitHub Actionsトリガー
4. Validatorが設定を検証
5. Generatorが静的ファイル生成
6. GitHub Pagesにデプロイ
7. 新しい短縮URLが利用可能に
```

### 4.2 リダイレクトフロー
```
1. ユーザーが短縮URLにアクセス
2. GitHub Pagesがindex.htmlを配信
3. ブラウザがHTMLを解析
4. redirect.jsが実行
5. アナリティクスイベント送信（設定時）
6. window.location.hrefでリダイレクト
7. （フォールバック）meta refreshでリダイレクト
8. ターゲットURLに到達
```

### 4.3 エラーハンドリングフロー
```
1. 存在しない短縮URLにアクセス
2. GitHub Pagesが404.htmlを配信
3. 404ページ表示
4. ユーザーに候補URLを提示
5. トップページまたは有効なURLへ誘導
```

## 5. セキュリティ設計

### 5.1 入力バリデーション
- **URL検証**: 有効なHTTP/HTTPSスキームのみ許可
- **短縮キー検証**: 英数字とハイフン、アンダースコアに制限
- **XSS対策**: HTML生成時のエスケープ処理
- **インジェクション対策**: テンプレート処理時のサニタイゼーション

### 5.2 リダイレクト先制限
- **ホワイトリスト**: 信頼できるドメインのリストを管理（オプション）
- **ブラックリスト**: 既知の悪意のあるサイトを除外
- **警告表示**: 外部サイトへのリダイレクト時に警告を表示（オプション）

### 5.3 HTTPS強制
- GitHub PagesのHTTPS強制機能を利用
- リダイレクト先もHTTPS推奨の警告

### 5.4 アクセス制御
- 設定ファイルは公開リポジトリでもOK（公開URLのみ含むため）
- プライベート短縮URLが必要な場合はプライベートリポジトリを使用

## 6. パフォーマンス設計

### 6.1 最適化戦略
- **HTML最小化**: ビルド時にHTML圧縮
- **CSS/JS最小化**: ミニファイ処理
- **キャッシュ戦略**: 適切なCache-Controlヘッダー設定（GitHub Pages側）
- **遅延読み込み**: 不要なリソースの遅延読み込み

### 6.2 リダイレクト速度最適化
- JavaScriptを使用した即座のリダイレクト
- 軽量なHTMLファイル（1-2KB程度）
- インラインスクリプトで外部ファイル読み込みを削減

### 6.3 スケーラビリティ
- 静的ファイル生成のため、URL数が増えてもパフォーマンス低下なし
- ビルド時間の最適化（並列処理、差分ビルド等）
- GitHub Pagesの帯域幅制限を考慮（月100GB）

## 7. テスト設計

### 7.1 単体テスト
- **Validatorテスト**: 各バリデーションルールの動作確認
- **Generatorテスト**: テンプレート処理の正確性確認
- **ユーティリティテスト**: ヘルパー関数の動作確認

### 7.2 統合テスト
- **ビルドパイプライン全体**: 設定からデプロイまでの一連の流れ
- **リダイレクト動作**: 生成されたHTMLの実際のリダイレクト動作
- **エラーハンドリング**: 404ページの表示確認

### 7.3 E2Eテスト
- **実環境デプロイ**: GitHub Pagesへの実際のデプロイテスト
- **ブラウザテスト**: 複数ブラウザでのリダイレクト動作確認
- **パフォーマンステスト**: リダイレクト速度の計測

## 8. 運用設計

### 8.1 URL追加手順
1. config/urls.jsonをエディタで開く
2. 新しいエントリを追加
3. ローカルでvalidatorを実行（オプション）
4. Git commit & push
5. GitHub Actionsの実行を確認
6. デプロイ完了後、短縮URLをテスト

### 8.2 URL更新手順
1. config/urls.jsonの該当エントリを編集
2. Git commit & push
3. 自動的に再ビルド・デプロイ

### 8.3 URL削除手順
1. config/urls.jsonから該当エントリを削除
2. Git commit & push
3. 再ビルドにより該当ディレクトリが削除される

### 8.4 監視・メンテナンス
- **GitHub Actionsログ**: ビルドエラーの監視
- **アナリティクス**: アクセス状況の確認
- **リンク切れチェック**: 定期的なリダイレクト先の生存確認
- **依存関係更新**: Node.js/Pythonパッケージの定期更新

## 9. 拡張性設計

### 9.1 プラグインアーキテクチャ
- ビルドプロセスにフックポイントを設ける
- カスタム処理の追加が容易な設計

### 9.2 将来の機能追加のための設計
- **QRコード生成**: 専用モジュールとして追加可能
- **有効期限**: urls.jsonにexpireフィールドを追加
- **アクセスカウンター**: 外部サービス連携で実装
- **パスワード保護**: リダイレクトページに認証UIを追加

### 9.3 マルチ言語対応
- 設定ファイルにlocaleフィールドを追加
- テンプレートの多言語化対応

## 10. ドキュメント構成

### 10.1 ユーザードキュメント
- **README.md**: プロジェクト概要、セットアップ手順
- **USER_GUIDE.md**: URL追加・管理の詳細手順
- **FAQ.md**: よくある質問と回答

### 10.2 開発者ドキュメント
- **CONTRIBUTING.md**: 貢献ガイドライン
- **API.md**: モジュールAPIリファレンス
- **ARCHITECTURE.md**: 詳細アーキテクチャ説明

### 10.3 インラインドキュメント
- JSDocまたはPyDocによるコードドキュメント
- 設定ファイルのスキーマドキュメント
